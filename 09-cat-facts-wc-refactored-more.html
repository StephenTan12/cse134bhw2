<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Random Cat Fact Component</title>
</head>
<body>

<h1>Cat Facts!</h1>
<random-cat-fact delay="3">
	Cats really are curious creatures
</random-cat-fact>

<script>
	class RandomCatFact extends HTMLElement {
		constructor() {
			super();

			this.CAT_FACT_URL = 'https://catfact.ninja/fact';
			this.delay = parseInt(this.getAttribute('delay')) || 30;

			this.attachShadow({ mode: 'open' });
			this.shadowRoot.innerHTML = `
                <style>
                    :host {
                        display: block;
                        padding: 1em;
                        margin: 0 auto;
                        max-width: 80%;
                        background-color: var(--background-color, #f0f0f0);
                        border: 1px solid var(--border-color, #ddd);
                        border-radius: var(--border-radius, 5px);
                        position: relative;
                    }
                    #fact {
                        opacity: 1;
                        font-size: var(--font-size, 1rem);
                        color: var(--text-color, #333);
                        transition: opacity 1s ease-in-out;
                    }
                    #countdownBar {
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        width: 100%;
                        height: 5px;
                        background-color: var(--bar-color, #007bff);
                    }
                    @media (prefers-reduced-motion) {
                        #fact {
                            transition: none;
                        }
                        #countdownBar {
                            transition: none;
                        }
                    }
                </style>
                <p id="fact"></p>
                <div id="countdownBar"></div>
            `;

			this.fetchCatFact();
		}

		connectedCallback() {
			this.startCountdown();
		}

		startCountdown() {
			clearInterval(this.interval);
			this.interval = setInterval(() => this.fetchCatFact(), this.delay * 1000);
			const bar = this.shadowRoot.getElementById('countdownBar');
			bar.style.transition = 'none';
			bar.style.width = '100%'; // Reset the bar width
			setTimeout(() => {
				bar.style.transition = `width ${this.delay}s linear`;
				bar.style.width = '0%'; // Start shrinking
			}, 100); // Allow time for CSS to reset
		}

		attributeChangedCallback(name, oldValue, newValue) {
			if (name === 'delay') {
				this.delay = parseInt(newValue) || 30;
				this.startCountdown();
			}
		}

		fetchCatFact() {
			const factElement = this.shadowRoot.getElementById('fact');
			factElement.style.opacity = 0;
			setTimeout(() => {
				fetch(this.CAT_FACT_URL)
					.then(response => response.json())
					.then(data => {
						this.displayFact(data.fact);
						this.startCountdown();
					})
					.catch(() => {
						this.displayFact("Oh no our network connection probably failed due to a cat attack!");
						this.startCountdown();
					});
			}, 1000);
		}

		displayFact(fact) {
			const factElement = this.shadowRoot.getElementById('fact');
			factElement.textContent = fact;
			if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
				factElement.style.opacity = 1;
			} else {
				setTimeout(() => factElement.style.opacity = 1, 100);
			}
		}

		disconnectedCallback() {
			clearInterval(this.interval);
		}

		static get observedAttributes() {
			return ['delay'];
		}
	}

	customElements.define('random-cat-fact', RandomCatFact);
</script>

</body>
</html>
